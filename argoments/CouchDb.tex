\chapter{CouchDb}

\section{Caratteristiche}

E' un sistema di gestione di basi di dati non relazionali. E' stato creato soprattutto per il mondo Web, progettato per poter gestire sia importanti quantita' di richieste attraverso
la rete sia per poter immagazzinare i dati in dispositivi mobili ed essere veloce. Utilizza una HTTP/JSON API per poter gestire le richieste ed inviare i dati, quindi
fa ampio utilizzo di POST, PUT, DELETE e cosi via. E' diventato un progetto Apache nel 2008, versione OpenSource di CouchServer.

Per poter eseguire query su CouchDB si utilizza Mango, un linguaggio di interrogazione JSON, molto simile a Mongo ma con alcune differenze, tra le piu'
importanti c'e' la mancanza dell'operatore di lookup ossia di join, infatti i tempi che presentero' successivamente sulle query di join sono 
sostanzialmente la somma di query di selezione sulle varie collezioni.
\section{Popolamento}

Per poter popolare i database contenti i diversi tipi di collezione si e' utilizzato le collezioni di documenti precedentemente create attraverso MongoDB e per ogni 
riga, ossia documento, attraverso una post all'indirizzo locale del server di CouchDB si e' potuta eseguire una query.

CouchDB richiede che il campo \verb|_id| sia una stringa, quindi attraverso il comando sed in uno script in bash si e' potuto riutilizzare le collezione esportate
da MongoDB, dato che il join non e' tra gli operatori di Mango, per generare nuovamente le collezioni.

\begin{Verbatim}

cat dataJSON/embedding_A_in_B.json  | sed -r 's/"_id":([0-9]+)/ "_id": "\1" /' >> dataCouchDB/embedding_A_in_B.json
cat dataJSON/embedding_B_in_A.json |  sed -r 's/"_id":([0-9]+)/ "_id": "\1" /'  >> dataCouchDB/embedding_B_in_A.json
cat dataJSON/referencing_A_in_B.json| sed -r 's/"_id":([0-9]+)/ "_id": "\1" /' >> dataCouchDB/referencing_A_in_B.json
cat dataJSON/referencing_B_in_A.json| sed -r 's/"_id":([0-9]+)/ "_id": "\1" /' >> dataCouchDB/referencing_B_in_A.json

\end{Verbatim}

\begin{Verbatim*}
import requests
import json

url = "http://admin:admin@127.0.0.1:5984/b"

payload = json.dumps({
  "_id": "738878",
  "BK": 738878,
  "B1": 94207,
  "B2": 176,
  "B3": 3,
  "B4": 94207,
  "B5": 176,
  "B6": 3,
  "B7": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. ........ " 
})
headers = {
  'Accept': 'application/json', 
  'Content-Type': 'application/json'
}

response = requests.request("POST", url, headers=headers, data=payload)

print(response.text)
\end{Verbatim*}

\section{Indici}

Gli indici all'interno di ogni collezione sono stati creati tramite uno script in python con un procedimento simile, per poter ottenere collezioni uguali in tutto e per tutto a 
quelle di MongoDB. 
Mango e' un linguaggio di query dichiarativo JSON per CouchDB. Gli indici di Mango con tipo json, sono costruiti usando viste MapReduce attraverso il seguente script in python:

\begin{Verbatim*}
import requests
import json
import os 

collections_a = [ 'referencing_b_in_a', 'embedding_b_in_a']
collections_b = ['embedding_a_in_b',  'referencing_a_in_b']

ind_a= ["A4",  "A5", "A6"]
ind_b= ["B4",  "B5", "B6"]

# A 
url = "http://admin:admin@127.0.0.1:5984/a/_index?partitioned=true"
for ind  in ind_a:
  payload = json.dumps({
    "index": {
      "fields": [
        ind
      ]
    },
    "name": ind + "-index",
    "type": "json"
  })
  headers = {
    'Content-Type': 'application/json'
  }

  response = requests.request("POST", url, headers=headers, data=payload)

  print(response.text)
payload = json.dumps({
  "index": {
    "fields": [
      "AK"
    ]
  },
  "name": "AK" + "-index",
  "type": "json"
})
headers = {
  'Content-Type': 'application/json'
}
response = requests.request("POST", url, headers=headers, data=payload)
print(response)

# B 
url = "http://admin:admin@127.0.0.1:5984/b/_index?partitioned=true"
for ind  in ind_b:
  payload = json.dumps({
    "index": {
      "fields": [
        ind
      ]
    },
    "name": ind + "-index",
    "type": "json"
  })
  headers = {
    'Content-Type': 'application/json'
  }

  response = requests.request("POST", url, headers=headers, data=payload)

  print(response.text)
payload = json.dumps({
  "index": {
    "fields": [
      "BK"
    ]
  },
  "name": "BK" + "-index",
  "type": "json"
})
headers = {
  'Content-Type': 'application/json'
}
response = requests.request("POST", url, headers=headers, data=payload)
print(response)

for collection in collections_a:
    url = "http://admin:admin@127.0.0.1:5984/" + collection + "/_index?partitioned=true"
    for ind  in ind_a:
        payload = json.dumps({
          "index": {
            "fields": [
              ind
            ]
          },
          "name": ind + "-index",
          "type": "json"
        })
        headers = {
          'Content-Type': 'application/json'
        }

        response = requests.request("POST", url, headers=headers, data=payload)

        print(response.text)

for collection in collections_b:
    url = "http://admin:admin@127.0.0.1:5984/" + collection + "/_index?partitioned=true"
    for ind  in ind_b:
        payload = json.dumps({
          "index": {
            "fields": [
              ind
            ]
          },
          "name": ind + "-index",
          "type": "json"
        })
        headers = {
          'Content-Type': 'application/json'
        }

        response = requests.request("POST", url, headers=headers, data=payload)

        print(response.text)

url = "http://admin:admin@127.0.0.1:5984/referencing_a_in_b/_index?partitioned=true"
payload = json.dumps({
  "index": {
    "fields": [
      "AK"
    ]
  },
  "name": "AK" + "-index",
  "type": "json"
})
headers = {
  'Content-Type': 'application/json'
}

response = requests.request("POST", url, headers=headers, data=payload)

# emb AB
url = "http://admin:admin@127.0.0.1:5984/embedding_a_in_b/_index?partitioned=true"
for ind in ind_a:
  payload = json.dumps({
    "index": {
      "fields": [
        "A." + ind
      ]
    },
    "name": "A." + ind + "-index",
    "type": "json"
  })
  headers = {
    'Content-Type': 'application/json'
  }
  response = requests.request("POST", url, headers=headers, data=payload)
  print(response.text)

# emb BA
url = "http://admin:admin@127.0.0.1:5984/embedding_b_in_a/_index?partitioned=true"
for ind in ind_b:
  payload = json.dumps({
    "index": {
      "fields": [
        "B." + ind
      ]
    },
    "name": "B." + ind + "-index",
    "type": "json"
  })
  headers = {
    'Content-Type': 'application/json'
  }
  response = requests.request("POST", url, headers=headers, data=payload)
  print(response.text)

# ref BA
url = "http://admin:admin@127.0.0.1:5984/referencing_b_in_a/_index?partitioned=true"
payload = json.dumps({
  "index": {
    "fields": [
      "B"
    ]
  },
  "name": "B" + "-index",
  "type": "json"
})
headers = {
  'Content-Type': 'application/json'
}
response = requests.request("POST", url, headers=headers, data=payload)
print(response.text)
\end{Verbatim*}